#!/usr/bin/env bash
# Template orgulhosamente criado por (Shell-Base)

#-----------HEADER-------------------------------------------------------------|
# AUTOR             : Vovolinux <suporte@vovolinux.com.br>
# HOMEPAGE          : https://vovolinux.com.br 
# DATA DE CRIAÇÃO   : 02/11/2021 às 00:52 
# PROGRAMA          : shell-util-core
# VERSÃO            : 1.0.0
# LICENÇA           : MIT - © 2021 - Vovolinux
# PEQUENA DESCRIÇÃO : Importa as bibliotecas do shell-util formando um core.
#
# CHANGELOG :
#
#------------------------------------------------------------------------------|

#--------------------------------- VARIÁVEIS ---------------------------------->
#
# Aqui vão todas as váriaveis do programa.

### VARIÁVEIS DO SCRIPT ###

# Autor
autor='Vovolinux'

# Programa
programa='shell-util-core'

# Versão
versao='1.0.0'

# Ano atual
ano='2021'

# Informação de Copyright
copyright="© 2021 - Vovolinux"

# Dependencias de shell_util
SU_FILE='os.su'

SU_FILES=(
    'menu.su'
    'os.su'
    'text.su'
)

SU_PKG='wget'

SU_PKGS=()

### VARIÁVEIS PARA MENSAGENS FIXAS ###
SU_MSG_NOT_INSTALLED="FAIL!\nPacote não está instalado.\n"
SU_MSG_FAIL_DEP="FAIL!\nDependência não foi satisfeita.\n"


### VARIÁVEIS PARA LINKS WEB ###

# Caminho para download das bibliotecas auxiliares de shell-util
SU_RAW='https://raw.githubusercontent.com/Viniciusalopes/shell-util/master'


### VARIÁVEIS DE DIRETÓRIOS E ARQUIVOS ###

# Diretório temporário para scripts auxiliares e dependências
SU_TMP='/tmp/shell-util'

#------------------------------- FIM-VARIÁVEIS --------------------------------<



#----------------------------------- FUNÇÕES ---------------------------------->
#

# Importa o shell-util-core e suas dependencias
# Incluir em scripts que utilizarão o shell-util-core
shell-util-core.grant_SU_CORE()
{
    local SU_RAW="https://raw.githubusercontent.com/Viniciusalopes/shell-util/master"
    local SU_MSG_NOT_INSTALLED="FAIL!\nPacote não está instalado.\n"
    local SU_MSG_FAIL_DEP="FAIL!\nDependência não foi satisfeita.\n"
    local SU_TMP="/tmp/shell-util"
    local SU_PKG="wget"
    local SU_FILE="shell-util-core.su"

    # Garante o diretório temporário
    # shell-util-core.grant_SU_TMP()
    # {
    # Cria o diretório para dependências
    if ! [[ -d ${SU_TMP} ]]; then
        mkdir -pv "${SU_TMP}"
    fi
    # }

    # Verifica se o programa está instalado
    # shell-util-core.grant_PKG()
    # {
    printf %b "grant_PKG '${SU_PKG}' -> "
    which ${SU_PKG}
    if [[ $? -ne 0 ]]; then
        printf %b "${SU_MSG_NOT_INSTALLED}"
        printf %b "try install dep -> "
        sudo apt install -y ${SU_PKG}
        if [[ $? -ne 0 ]]; then
            printf %b "${SU_MSG_FAIL_DEP}" && exit 1
        fi
    fi
    # }

    # Garante o shell_util.so
    # shell-util-core.grant_OS()
    # {
    printf %b "grant_FILE '${SU_FILE}' -> "
    
    if [[ -f "${SU_TMP}/${SU_FILE}" ]]; then
        printf %b "OK\n"
    else
        wget -v ${SU_RAW}/${SU_FILE} -O ${SU_TMP}/${SU_FILE}
        # Encerra se não conseguir fazer o download do arquivo
        if [[ $? -ne 0 ]]; then
            printf %b "${SU_MSG_FAIL_DEP}" \
            && rm -rfv ${SU_TMP}/${SU_FILE} \
            && exit 1
        fi
    fi
    source ${SU_TMP}/${SU_FILE}
    # }
}

# Corrige o path 
shell-util-core.sanitize_path()
{
    local _path=$1
    # Se não informar o diretório
    [[ "${_path}" = "" ]] && _path="$PWD"

    # Substitui o ~ (til) pelo endereço absoluto da home do usuário
    [[ "${_path:0:2}" = "~/" ]] && _path="${HOME}${_path: 1}" 

    # Retira a barra do final
    [[ "${_path: -1}" = "/" ]] && _path="${_path::-1}" 

    printf %b "${_path}"    
}

# Garante o diretório passado no primeiro argumento
# $1=Path do diretório
# $2=sudo
# $2=Proprietário e Grupo
shell-util-core.grant_DIR()
{
    local _dir=$(shell-util-core.sanitize_path $1)
    if ! [[ -d ${_dir} ]]; then
        $2 mkdir -pv "${_dir}"
        if ! [[ "${3}" = "" && -d "${_dir}" ]]; then
            sudo chown $3:$3 ${_dir} -Rf
        fi
    fi
}

# Verifica se o programa está instalado
shell-util-core.grant_PKG()
{
    printf %b "grant_PKG '${SU_PKG}' -> "
    which ${SU_PKG}
    if [[ $? -ne 0 ]]; then
        printf %b "${SU_MSG_NOT_INSTALLED}"
        printf %b "try install dep -> "
        if [[ "${SU_PKG}" -eq "docker" ]]; then
            sudo apt install -y docker.io docker-compose
        else
            sudo apt install -y ${SU_PKG}
        fi
        
        if [[ $? -ne 0 ]]; then
            printf %b "${SU_MSG_FAIL_DEP}" && exit 1
        fi
    fi
}

shell-util-core.get_PKGS()
{
    printf %b "${SU_PKGS[@]}\n"
    for p in "${SU_PKGS[@]}"; do
        SU_PKG="${p}"
        shell-util-core.grant_PKG
    done
}

# Garante o shell_util.so
shell-util-core.grant_FILE()
{
    printf %b "grant_FILE '${SU_FILE}' -> "
    
    if [[ -f "${SU_TMP}/${SU_FILE}" ]]; then
        printf %b "OK\n"
    else
        wget -v ${SU_RAW}/${SU_FILE} -O ${SU_TMP}/${SU_FILE}
        # Encerra se não conseguir fazer o download do arquivo
        if [[ $? -ne 0 ]]; then
            printf %b "${SU_MSG_FAIL_DEP}" \
            && rm -rfv ${SU_TMP}/${SU_FILE} \
            && exit 1
        fi
    fi
}

shell-util-core.get_LIBS() {
    for f in "${SU_FILES[@]}"; do
        SU_FILE=${f}
        shell-util-core.grant_FILE
        source ${SU_TMP}/${f}
    done
}

shell-util-core.get_FILES()
{
    for f in "${SU_FILES[@]}"; do
        SU_FILE=${f}
        shell-util-core.grant_FILE
    done
}
#--------------------------------- FIM-FUNÇÕES --------------------------------<



#---------------------------------- TESTES ------------------------------------>
#
# Testes iniciais do seu programa vão neste bloco.


#--------------------------------- FIM-TESTES ---------------------------------<

# Programa começa aqui :)

shell-util-core.grant_DIR $SU_TMP
shell-util-core.grant_PKG
shell-util-core.get_LIBS
